{#
    Copyright (c) 2023 Coalesce. All rights reserved.
This script and its associated documentation are confidential and proprietary to Coalesce.
Unauthorized reproduction, distribution, or disclosure of this material is strictly prohibited.
Coalesce permits you to copy and modify this script for the purposes of using with Coalesce but
does not permit copying or modification for any other purpose.
#}
{# == Node Type Version        : 1  == #}
{# == Node Type Name           : LDP  == #}
{# == Node Type Description    : This node creates a streaming table in the target == #}
    

{% if desiredState == undefined %}

    {# View Name #}
    {% set targetObjectDatabase = ref_no_link(currentState.node.location.name, currentState.node.name).split('.')[0] %} 
    {% set targetObjectSchema = ref_no_link(currentState.node.location.name, currentState.node.name).split('.')[1] %} 
    {% set fullyQualifiedTargetObjectName = ref_no_link(currentState.node.location.name, currentState.node.name) %}
    
       {{ stage('Drop Streaming table' , true, "sql", "drop") }}
       DROP TABLE IF EXISTS {{ fullyQualifiedTargetObjectName }}


{% elif currentState == undefined or (currentState != undefined and desiredState != currentState) %}

  
    {% set ns = namespace( storageLocationTest= true,
    descolchanges = 0,othercolchanges = 0,clusterTest = false,colchanges=0,nsCurrentDepStorageLocations="",nsCurrentSourceStorageLocations="",nsDesiredDepStorageLocations="",nsDesiredSourceStorageLocations="",sourcestorageLocationTest=true,scheduleref="",createTst=false,alterTest=false,fileproptst=true,joinTest=true ) %}
	
  		{%if currentState !=undefined%}   

		{# Node #}
             {% set nodeNameTest = currentState.node.name == desiredState.node.name %}		   
             {%set nodeCommentTest = currentState.node.description == desiredState.node.description %}
             
        {% set sourcesTest = currentState.sources | count == desiredState.sources | count %}
		
        {%if sourcesTest == true%}
           {% for src in desiredState.sources %}
            {% if  currentState.sources[loop.index0].join != src.join %}
                {% set ns.joinTest = false %}  {# Set joinTest to false if changes are detected #}
            {% endif %}
           {% endfor %}
        {%endif%}

        {# Change Node Name or Change Storage Location #}
        {# Storage Location Tests #}
        {# Test  #}
        {%if currentState.storageLocations|length == 0%}          
              {% set currentDatabase = currentState.storageLocations | selectattr('name', 'equalto', currentState.node.location.name) | map(attribute='database') | string %}
              {% set currentSchema = currentState.storageLocations | selectattr('name', 'equalto', currentState.node.location.name) | map(attribute='schema') | string %}
               {% set currentDatabaseSchema = currentDatabase + '.' + currentSchema %}
               
        {%else %}   
            {# Current target node mappings #}
            {% set currentDatabase = currentState.storageLocations | selectattr('name', 'equalto', currentState.node.location.name) | map(attribute='database') | first %}
            {% set currentSchema = currentState.storageLocations | selectattr('name', 'equalto', currentState.node.location.name) | map(attribute='schema') | first %}
            {% set currentDatabaseSchema = currentDatabase + '.' + currentSchema %}  
		    {% endif %}		 
        
            {# Desired target node mappings #}
            {% set desiredDatabase = desiredState.storageLocations | selectattr('name', 'equalto', desiredState.node.location.name) | map(attribute='database') | first %}
            {% set desiredSchema = desiredState.storageLocations | selectattr('name', 'equalto', desiredState.node.location.name) | map(attribute='schema') | first %}
            {% set desiredDatabaseSchema = desiredDatabase + '.' + desiredSchema %}           
            
        {% if currentDatabaseSchema != desiredDatabaseSchema %}
            {% set ns.storageLocationTest = false %}
        {% endif %}

          
          {# Test to see if the transform in a column has changed #}
          {% set desiredTransformArray = desiredState.sources | map(attribute='columns') | first | map(attribute='transform') | list -%}
          {# Current Namespace Variables Transform #}
          {% set currentTransformArray = currentState.sources | map(attribute='columns') | first | map(attribute='transform') | list -%}


          {% set columnsTransformTest = currentTransformArray == desiredTransformArray %}

          {#Partition by test#}
          {%set partitiontest = currentState.config.partclause == desiredState.config.partclause %}

          {#Table properties test#}
          {%set tblproptst = currentState.config.tblproperties == desiredState.config.tblproperties%}

          {#Table Constraints#}
          {%set tblconsttst = currentState.config.tableconstraints == desiredState.config.tableconstraints%}

          {#Other Constraints#}
          {%set consttst = currentState.config.constraints == desiredState.config.constraints%}

          {#Read files#}
          {%set  filetst = currentState.config.readfiles ==  desiredState.config.readfiles %}


          {%if currentState.config.readfiles == true and  desiredState.config.readfiles == true%}
           
            {%if currentState.config.fileloc != desiredState.config.fileloc or currentState.config.fileformat != desiredState.config.fileformat or currentState.config.inccolumns != desiredState.config.inccolumns%}

             {%set ns.fileproptst = false %}
            
          {%endif%}

          {%endif%}

		    {#Add columns#}
            {% for addDesCol in desiredState.columns %}
                {% if addDesCol.id not in currentState.columns | map(attribute="id") %}
                {% set ns.colchanges = ns.colchanges + 1 %}
                {% endif %}
            {% endfor %}
			
			
			{# Rename Columns #}
            {% for renameCurCol in currentState.columns %}
                {% if renameCurCol.id in desiredState.columns | map(attribute="id") %}
                    {% set desiredColumnName = desiredState.columns | selectattr('id', 'equalto', renameCurCol.id) | map(attribute='name') | first %}
                    {% if renameCurCol.name != desiredColumnName %}
                        {% set ns.colchanges = ns.colchanges + 1 %}
                    {% endif %}
                {% endif %}
            {% endfor %}

             
			{# Drop Columns #}
            {% for dropCurCol in currentState.columns %}
                {% if dropCurCol.id not in desiredState.columns | map(attribute="id") %}
                  {% set ns.colchanges = ns.colchanges + 1 %}
                {% endif %}
            {% endfor %}
	
            {#Column level changes test#}
			{% for alterCurCol in currentState.columns %}        
                {% if alterCurCol.id in desiredState.columns | map(attribute="id") %}
                     {% set currentColumnName = currentState.columns | selectattr('id', "equalto", alterCurCol.id) | map(attribute='name') | first %}
                    {% set currentDescription = currentState.columns | selectattr('id', "equalto", alterCurCol.id) | map(attribute='description') | first %}
                    {% set currentDatatype = currentState.columns | selectattr('id', "equalto", alterCurCol.id) | map(attribute='dataType') | first %}
                    {% set currentNullable = currentState.columns | selectattr('id', "equalto", alterCurCol.id) | map(attribute='nullable') | first %}
                    {% set currentDefaultValue = currentState.columns | selectattr('id', "equalto", alterCurCol.id) | map(attribute='defaultValue') | first %}
                    
                    {% set desiredColumnName = desiredState.columns | selectattr('id', "equalto", alterCurCol.id) | map(attribute='name') | first %}
                    {% set desiredDescription = desiredState.columns | selectattr('id', "equalto", alterCurCol.id) | map(attribute='description') | first %}
                    {% set desiredDatatype = desiredState.columns | selectattr('id', "equalto", alterCurCol.id) | map(attribute='dataType') | first %}
                    {% set desiredNullable = desiredState.columns | selectattr('id', "equalto", alterCurCol.id) | map(attribute='nullable') | first %}
                    {% set desiredDefaultValue = desiredState.columns | selectattr('id', "equalto", alterCurCol.id) | map(attribute='defaultValue') | first %}
                        

                   {% set datatypeTest = currentDatatype == desiredDatatype %}
                   {% set nullableTest = currentNullable == desiredNullable %}
                   {% set defaultValueTest = currentDefaultValue == desiredDefaultValue %}
                   {% set descriptionTest = currentDescription == desiredDescription %}
                   {% set columnnameTest = currentColumnName == desiredColumnName %}

                    {% if (descriptionTest == false) %}
                        {% set ns.descolchanges = ns.descolchanges + 1 %}
                    {%endif%} 														
                    {%if (datatypeTest == false or nullableTest == false or defaultValueTest == false or columnnameTest == false )%} 
                       {% set ns.othercolchanges = ns.othercolchanges + 1 %}                                      
                     {%endif%} 																										
                {%endif%}    
            {% endfor %}
         
    
           {#config level changes #}
		  
		   	{% set nodeNameTest = currentState.node.name == desiredState.node.name %}

            {% if 
			      ns.othercolchanges > 0 or 
			      ns.descolchanges > 0 or 
			      ns.colchanges > 0 or 
			      joinTest == false or 
			      columnsTransformTest == false or 
            ns.sourcestorageLocationTest == false or
             ns.storageLocationTest == false or 
             nodeNameTest == false or 
             nodeCommentTest == false 
             or sourcesTest == false
             or partitiontest == false
             or tblproptst == false
             or tblconsttst == false
             or consttst == false 
             or filetst == false
             or ns.fileproptst == false
             %}    
            {% set ns.createTst = true %}
          {% else %}
            {% set ns.createTst = false %}
         {% endif %}      		 
           
           {# Figure out refresh schedule #}
        
         {% if currentState.config.schedulerefresh == true and desiredState.config.schedulerefresh == false %}
		     {%set ns.scheduleref='DROP'%}
             {%elif currentState.config.schedulerefresh == false and desiredState.config.schedulerefresh == true%}  
              {%set ns.scheduleref='ADD'%}  
	         {%elif currentState.config.schedulerefresh == true and desiredState.config.schedulerefresh == true%}

             {%if currentState.config.CRON !=desiredState.config.CRON or (currentState.config.tp !=desiredState.config.tp) or (currentState.config.tph !=desiredState.config.tph) or (currentState.config.schedulePeriodOption !=desiredState.config.schedulePeriodOption) %}
                        {%set ns.scheduleref='ALTER'%}
             {%endif%} 				
        
         {% endif %}

          {%if ns.createTst == false and ns.scheduleref != ""  %}    
           {%set ns.alterTest = true %}		   
	     {%endif%}
    {%endif%}

  {%if currentState == undefined or ns.createTst == true %}
       
       
    # Storage Location-database and schema

   {%if desiredState.config.readfiles != true%}
       {% set srcSchName = desiredState.sources[0].dependencies[0].node.location.name %}
      {% set db = desiredState.storageLocations | selectattr('name', 'equalto', srcSchName) | map(attribute='database') | first %}
       {% set sch = desiredState.storageLocations | selectattr('name', 'equalto', srcSchName) | map(attribute='schema') | first %}
   {%endif%}


   # Target Location database and schema

   {% set tgtSchName = desiredState.node.location.name %}
   {% set tdb = desiredState.storageLocations | selectattr('name', 'equalto', tgtSchName) | map(attribute='database') | first %}
   {% set tsch = desiredState.storageLocations | selectattr('name', 'equalto', tgtSchName) | map(attribute='schema') | first %}

   {%- set nsVariables = namespace(partValues="",primarykeyValues="",foreignkeyValues="",oconstraints="") %}    

   # Partition by clause

    {%if desiredState.config.partclause == true%}

       {% set column = desiredState.config.partitionclause.get('items') | map(attribute='partname.name')| list%}
	 
	      {% for r in column %}
			   {% set nsVariables.partValues = nsVariables.partValues + r %}
         {%- if not loop.last -%} {% set nsVariables.partValues = nsVariables.partValues +','%} {% endif %}
        {% endfor %}
       
         {% set nsVariables.partValues = 'PARTITIONED BY(' + nsVariables.partValues + ')' %}
    {%endif%}

    # Primary key clause

    {%if desiredState.config.primary == true%}

     {% set column = desiredState.config.primarykeycon.get('items') | map(attribute='primarykey.name')| list%}
   
	      {% for r in column %}
			   {% set nsVariables.primarykeyValues = nsVariables.primarykeyValues +r %}
         {%- if not loop.last -%} {% set nsVariables.primarykeyValues = nsVariables.primarykeyValues +','%} {% endif %}
        {% endfor %}
       
         {% set nsVariables.primarykeyValues = 'CONSTRAINT ' + desiredState.config.primarykeyname + ' PRIMARY KEY ('+nsVariables.primarykeyValues +')' %}

   {%endif%}

   #Foreign key clause

    {%if desiredState.config.foreign == true%}

     {% set column = desiredState.config.foreignkeycon.get('items') | map(attribute='foreignkey.name')| list%}
	 
	      {% for r in column %}
			   {% set nsVariables.foreignkeyValues = nsVariables.foreignkeyValues +r %}
         {%- if not loop.last -%} {% set nsVariables.foreignkeyValues = nsVariables.foreignkeyValues +','%} {% endif %}
        {% endfor %}
       
         {% set nsVariables.foreignkeyValues = 'CONSTRAINT ' + desiredState.config.foreignkeyname + ' FOREIGN KEY ('+nsVariables.foreignkeyValues +')' + ' REFERENCES '+ desiredState.config.parentabname %}
   {%endif%}

    #Other constraints

    {%if desiredState.config.constraints == true%}	
	       {% set column, expression,violation = desiredState.config.constraintsspec.get('items') | map(attribute='columnName.name')| list, desiredState.config.constraintsspec.get('items') | map(attribute='sqlExpression') | list ,
	      desiredState.config.constraintsspec.get('items') | map(attribute='onviolation') | list%}
     
	    {% for r in column %}
			{%set nsVariables.oconstraints = nsVariables.oconstraints + 'CONSTRAINT ' + r + ' EXPECT('+ expression[loop.index0] + ') ON VIOLATION ' + violation[loop.index0] %}
        {% if not loop.last %}
      {%set nsVariables.oconstraints = nsVariables.oconstraints +',' %}
      {% endif %}                
       {% endfor %}
	{%endif%}


{# CreateSQL for Table #}
{% set ns = namespace(format_options=[]) %}

{# 1. Format Specific Options #}
{% if desiredState.config.fileformat | lower == 'csv' %}
    {% set csv_opts = [] %}
    {% if desiredState.config.delimiter %}{% set _ = csv_opts.append("'delimiter' = '" ~ desiredState.config.delimiter ~ "'") %}{% endif %}
    {% if desiredState.config.header is defined %}{% set _ = csv_opts.append("'header' = '" ~ (desiredState.config.header | string | lower) ~ "'") %}{% endif %}
    {% if desiredState.config.mulline is defined %}{% set _ = csv_opts.append("'multiLine' = '" ~ (desiredState.config.mulline | string | lower) ~ "'") %}{% endif %}
    {% if desiredState.config.comment %}{% set _ = csv_opts.append("'comment' = '" ~ desiredState.config.comment ~ "'") %}{% endif %}
    {% if desiredState.config.skipRows %}{% set _ = csv_opts.append("'skipRows' = '" ~ desiredState.config.skipRows ~ "'") %}{% endif %}
    {% if desiredState.config.quote %}{% set _ = csv_opts.append("'quote' = '" ~ desiredState.config.quote ~ "'") %}{% endif %}
    {% if desiredState.config.escape %}{% set _ = csv_opts.append("'escape' = '" ~ desiredState.config.escape ~ "'") %}{% endif %}
    {% if desiredState.config.ignoreLeadingWhiteSpace is defined %}{% set _ = csv_opts.append("'ignoreLeadingWhiteSpace' = '" ~ (desiredState.config.ignoreLeadingWhiteSpace | string | lower) ~ "'") %}{% endif %}
    {% if desiredState.config.ignoreTrailingWhiteSpace is defined %}{% set _ = csv_opts.append("'ignoreTrailingWhiteSpace' = '" ~ (desiredState.config.ignoreTrailingWhiteSpace | string | lower) ~ "'") %}{% endif %}
    {% if desiredState.config.nullvalue %}{% set _ = csv_opts.append("'nullValue' = '" ~ desiredState.config.nullvalue ~ "'") %}{% endif %}
    {% if desiredState.config.dateFormat %}{% set _ = csv_opts.append("'dateFormat' = '" ~ desiredState.config.dateFormat ~ "'") %}{% endif %}
    {% if desiredState.config.timestampFormat %}{% set _ = csv_opts.append("'timestampFormat' = '" ~ desiredState.config.timestampFormat ~ "'") %}{% endif %}
    {% set ns.format_options = ns.format_options + csv_opts %}

{% elif desiredState.config.fileformat | lower == 'json' %}
    {% set json_opts = [] %}
    {% if desiredState.config.mulline is defined %}{% set _ = json_opts.append("'multiLine' = '" ~ (desiredState.config.mulline | string | lower) ~ "'") %}{% endif %}
    {% set ns.format_options = ns.format_options + json_opts %}

{% elif desiredState.config.fileformat | lower == 'excel' %}
    {% set excel_opts = [] %}
    {% if desiredState.config.headerrows %}{% set _ = excel_opts.append("'headerRows' = '" ~ desiredState.config.headerrows ~ "'") %}{% endif %}
    {% if desiredState.config.dataaddress %}{% set _ = excel_opts.append("'dataAddress' = '" ~ desiredState.config.dataaddress ~ "'") %}{% endif %}
    {% set ns.format_options = ns.format_options + excel_opts %}

{% elif desiredState.config.fileformat | lower == 'xml' %}
    {% set xml_opts = [] %}
    {% if desiredState.config.xmlrwTag %}{% set _ = xml_opts.append("'rowTag' = '" ~ desiredState.config.xmlrwTag ~ "'") %}{% endif %}
    {% if desiredState.config.xmlvalTag %}{% set _ = xml_opts.append("'valueTag' = '" ~ desiredState.config.xmlvalTag ~ "'") %}{% endif %}
    {% if desiredState.config.attributePrefix %}{% set _ = xml_opts.append("'attributePrefix' = '" ~ desiredState.config.attributePrefix ~ "'") %}{% endif %}
    {% if desiredState.config.rowValidationXSDPath %}{% set _ = xml_opts.append("'rowValidationXSDPath' = '" ~ desiredState.config.rowValidationXSDPath ~ "'") %}{% endif %}
    {% if desiredState.config.samplingRatio %}{% set _ = xml_opts.append("'samplingRatio' = '" ~ desiredState.config.samplingRatio ~ "'") %}{% endif %}
    {% if desiredState.config.excludeAttribute is defined %}{% set _ = xml_opts.append("'excludeAttribute' = '" ~ (desiredState.config.excludeAttribute | string | lower) ~ "'") %}{% endif %}
    {% if desiredState.config.ignoreSurroundingSpaces is defined %}{% set _ = xml_opts.append("'ignoreSurroundingSpaces' = '" ~ (desiredState.config.ignoreSurroundingSpaces | string | lower) ~ "'") %}{% endif %}
    {% if desiredState.config.ignoreNamespace is defined %}{% set _ = xml_opts.append("'ignoreNamespace' = '" ~ (desiredState.config.ignoreNamespace | string | lower) ~ "'") %}{% endif %}
    {% if desiredState.config.datetimeRebaseMode %}{% set _ = xml_opts.append("'datetimeRebaseMode' = '" ~ desiredState.config.datetimeRebaseMode ~ "'") %}{% endif %}
    {% if desiredState.config.int96ebaseMode %}{% set _ = xml_opts.append("'int96RebaseMode' = '" ~ desiredState.config.int96ebaseMode ~ "'") %}{% endif %}
    {% if desiredState.config.nullvalue %}{% set _ = xml_opts.append("'nullValue' = '" ~ desiredState.config.nullvalue ~ "'") %}{% endif %}
    {% set ns.format_options = ns.format_options + xml_opts %}

{% elif desiredState.config.fileformat | lower == 'text' %}
    {% set text_opts = [] %}
    {% if desiredState.config.lineSep %}{% set _ = text_opts.append("'lineSep' = '" ~ desiredState.config.lineSep ~ "'") %}{% endif %}
    {% if desiredState.config.wholeText %}{% set _ = text_opts.append("'wholeText' = '" ~ (desiredState.config.wholeText | string | lower) ~ "'") %}{% endif %}
    {% set ns.format_options = ns.format_options + text_opts %}

{% elif desiredState.config.fileformat | lower == 'avro' %}
    {% if desiredState.config.aschemaopt %}{% set _ = ns.format_options.append("'avroSchema' = '" ~ desiredState.config.aschemaopt ~ "'") %}{% endif %}
    {% if desiredState.config.datetimeRebaseMode %}{% set _ = ns.format_options.append("'datetimeRebaseMode' = '" ~ desiredState.config.datetimeRebaseMode ~ "'") %}{% endif %}

{% elif desiredState.config.fileformat | lower == 'parquet' %}
    {% if desiredState.config.datetimeRebaseMode %}{% set _ = ns.format_options.append("'datetimeRebaseMode' = '" ~ desiredState.config.datetimeRebaseMode ~ "'") %}{% endif %}
    {% if desiredState.config.int96ebaseMode %}{% set _ = ns.format_options.append("'int96RebaseMode' = '" ~ desiredState.config.int96ebaseMode ~ "'") %}{% endif %}
{% endif %}

{# 2. Common & Advanced Options #}
{% set common_opts = [] %}
{% if desiredState.config.encoding %}{% set _ = common_opts.append("'encoding' = '" ~ desiredState.config.encoding ~ "'") %}{% endif %}
{% if desiredState.config.rescuedDataColumn %}{% set _ = common_opts.append("'rescuedDataColumn' = '" ~ desiredState.config.rescuedDataColumn ~ "'") %}{% endif %}
{% if desiredState.config.mergeSchema is defined %}{% set _ = common_opts.append("'mergeSchema' = '" ~ (desiredState.config.mergeSchema | string | lower) ~ "'") %}{% endif %}
{% if desiredState.config.infercolumntypes is defined %}{% set _ = common_opts.append("'inferSchema' = '" ~ (desiredState.config.infercolumntypes | string | lower) ~ "'") %}{% endif %}
{% if desiredState.config.igcorfiles is defined %}{% set _ = common_opts.append("'ignoreCorruptFiles' = '" ~ (desiredState.config.igcorfiles | string | lower) ~ "'") %}{% endif %}
{% if desiredState.config.igmisfiles is defined %}{% set _ = common_opts.append("'ignoreMissingFiles' = '" ~ (desiredState.config.igmisfiles | string | lower) ~ "'") %}{% endif %}
{% if desiredState.config.recursiveFileLookup is defined %}{% set _ = common_opts.append("'recursiveFileLookup' = '" ~ (desiredState.config.recursiveFileLookup | string | lower) ~ "'") %}{% endif %}
{% if desiredState.config.modifiedAfter %}{% set _ = common_opts.append("'modifiedAfter' = '" ~ desiredState.config.modifiedAfter ~ "'") %}{% endif %}
{% if desiredState.config.modifiedBefore %}{% set _ = common_opts.append("'modifiedBefore' = '" ~ desiredState.config.modifiedBefore ~ "'") %}{% endif %}

{% set ns.format_options = ns.format_options + common_opts %}

{{ stage('CREATE '+ desiredState.config.DLTtype,true, "sql", "create" ) }}

CREATE OR REFRESH {{desiredState.config.DLTtype}} 
{%-if desiredState.config.readfiles != true%}{{ ref_no_link(desiredState.node.location.name, desiredState.node.name) }}
{%else%}
`{{tdb}}`.`{{tsch}}`.`{{desiredState.node.name}}`
{%endif%}
{%- if desiredState.config.readfiles != true or desiredState.config.inccolumns == true%}
      (
        {% for col in columns %}
            `{{ col.name }}` {{ col.dataType }}
            {%- if not col.nullable %} NOT NULL
            {% endif %}
            {%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
            {%- if not loop.last %}, {% endif %}
            {%-if loop.last and (desiredState.config.foreign == true or desiredState.config.primary == true) -%},{%endif%}
        {% endfor %}
{% if desiredState.config.primary == true%} {{nsVariables.primarykeyValues}}{%if desiredState.config.foreign == true -%},{%endif-%}{%endif%}
  {%if desiredState.config.foreign == true%}{{nsVariables.foreignkeyValues}}{%endif%}
  {%if desiredState.config.constraints == true%}{{nsVariables.oconstraints}}{%endif%}  )
  {%-endif-%} 
  
    {% if desiredState.node.description | length > 0 -%} COMMENT '{{ desiredState.node.description |escape }}'{%- endif%}
    {% if desiredState.config.partclause == true %} {{ nsVariables.partValues }} {%endif%}
    {%if desiredState.config.tblproperties != ""-%}TBLPROPERTIES ({{desiredState.config.tblproperties}}){%endif%}
    {%-if desiredState.config.schedulerefresh == true%}SCHEDULE REFRESH {% if desiredState.config.schedulePeriodOption =='CRON'%}  CRON '{{desiredState.config.cron}}' {%if desiredState.config.crontz !="" %} AT TIME ZONE '{{desiredState.config.crontz}}' {%endif%}{%endif%}
         {%-if desiredState.config.schedulePeriodOption !='CRON' and desiredState.config.tp == 'EVERY HOURS' %}
         EVERY {{desiredState.config.tph}} HOURS
         {%-elif desiredState.config.schedulePeriodOption !='CRON' and desiredState.config.tp == 'EVERY DAYS' %}
         EVERY {{desiredState.config.tph}} DAYS
         {%-elif desiredState.config.schedulePeriodOption !='CRON' and desiredState.config.tp == 'EVERY WEEKS' %}
         EVERY {{desiredState.config.tph}} WEEKS   
         {%- endif%}
         {%- endif%}
    AS
    SELECT 
    {%if desiredState.config.readfiles == true and desiredState.config.inccolumns == false%} * 
    {%elif desiredState.config.readfiles == true and desiredState.config.inccolumns == true%}
	{% for col in desiredState.sources[0].columns %}
	{%if col.transform == ""%}
	     `{{ col.name }}`      
	{%else%}
          {{ get_source_transform(col) }} AS `{{ col.name }}`
    {%endif%}
            {%- if not loop.last -%}, {% endif %}
    {% endfor %}
	{%else%}
    {% for col in desiredState.sources[0].columns %}
                 {{ get_source_transform(col) }} AS `{{ col.name }}`
            {%- if not loop.last -%}, {% endif %}
    {% endfor %}
    {%-endif%}  
    FROM {%if desiredState.config.DLTtype == 'STREAMING TABLE'%} STREAM {%endif%}    
    {%if desiredState.config.readfiles == true %} 
       read_files('{{desiredState.config.fileloc}}',
       format=>'{{desiredState.config.fileformat}}'
       {%if desiredState.config.filepat !=""%},pathGlobFilter =>'{{desiredState.config.filepat}}'{%endif%}
       {%if desiredState.config.fileformat == 'csv'%},delimiter=>'{{desiredState.config.delimiter}}',
       header=> {%if desiredState.config.header == True %}true {%else%} false{%endif%}
       {%elif desiredState.config.fileformat == 'json'%}
       
       {%endif%});
    {%else%}
    {{desiredState.sources[0].join|replace("FROM","")}}
    {%endif%}
  
 {%endif%}
     {%if ns.alterTest == true %}
         
       {{ stage('Alter schedule refresh', true, "sql", "alter") }}
                {% set srcSchName = currentState.node.location.name %}
                {% set cdb = currentState.storageLocations | selectattr('name', 'equalto', srcSchName) | map(attribute='database') | first %}
                {% set csch = currentState.storageLocations | selectattr('name', 'equalto', srcSchName) | map(attribute='schema') | first %}

               {%if ns.scheduleref == 'DROP'%}
                 ALTER STREAMING TABLE  `{{cdb}}`.`{{csch}}`.`{{desiredState.node.name}}` {{ns.scheduleref}} SCHEDULE

               {%else%}
                ALTER STREAMING TABLE  `{{cdb}}`.`{{csch}}`.`{{desiredState.node.name}}`
                {{ns.scheduleref}}  {%if desiredState.config.schedulerefresh == true-%} SCHEDULE REFRESH {% if desiredState.config.schedulePeriodOption =='CRON'%}  CRON '{{desiredState.config.cron}}' {%if desiredState.config.crontz !="" %} AT TIME ZONE '{{desiredState.config.crontz}}' {%endif%}{%endif%}
                {%- if desiredState.config.schedulePeriodOption != 'CRON' -%}
                   {%- if desiredState.config.tp == 'EVERY HOURS' -%}
                      EVERY {{ desiredState.config.tph }} HOURS
                   {%- elif desiredState.config.tp == 'EVERY DAYS' -%}
                       EVERY {{ desiredState.config.tph }} DAYS
                   {%- elif desiredState.config.tp == 'EVERY WEEKS' -%}
                       EVERY {{ desiredState.config.tph }} WEEKS
                   {%- endif %}
                {%- endif %}
               {%endif%} 
            {%endif%}           
    {%endif%}
{%endif%}