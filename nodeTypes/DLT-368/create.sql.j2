{#
    Copyright (c) 2023 Coalesce. All rights reserved.
This script and its associated documentation are confidential and proprietary to Coalesce.
Unauthorized reproduction, distribution, or disclosure of this material is strictly prohibited.
Coalesce permits you to copy and modify this script for the purposes of using with Coalesce but
does not permit copying or modification for any other purpose.
#}
{# == Node Type Version        : 1  == #}
{# == Node Type Name           : DLT  == #}
{# == Node Type Description    : This node creates a streaming table in the target == #}


{% if desiredState == undefined %}

    {# View Name #}
    {% set targetObjectDatabase = ref_no_link(currentState.node.location.name, currentState.node.name).split('.')[0] %} 
    {% set targetObjectSchema = ref_no_link(currentState.node.location.name, currentState.node.name).split('.')[1] %} 
    {% set fullyQualifiedTargetObjectName = ref_no_link(currentState.node.location.name, currentState.node.name) %}
    
       {{ stage('Drop Streaming table' , true, "sql", "drop") }}
       DROP TABLE IF EXISTS {{ fullyQualifiedTargetObjectName }}

{% elif currentState == undefined or (currentState != undefined and desiredState != currentState) %}

# Storage Location-database and schema

{%if desiredState.config.readfiles != true%}
{% set srcSchName = desiredState.sources[0].dependencies[0].node.location.name %}
{% set db = storageLocations | selectattr('name', 'equalto', srcSchName) | map(attribute='database') | first %}
{% set sch = storageLocations | selectattr('name', 'equalto', srcSchName) | map(attribute='schema') | first %}
{%endif%}


# Target Location database and schema

{% set tgtSchName = desiredState.node.location.name %}
{% set tdb = storageLocations | selectattr('name', 'equalto', tgtSchName) | map(attribute='database') | first %}
{% set tsch = storageLocations | selectattr('name', 'equalto', tgtSchName) | map(attribute='schema') | first %}

{%set join_clause = desiredState.sources[0].join %}
{% set parts = join_clause.split('FROM') %}
{% set other_clause = parts[1] %}
{%- set nsVariables = namespace(partValues="",primarykeyValues="",foreignkeyValues="",oconstraints="") %}    
# Partition by clause

{%if desiredState.config.partclause == true%}

       {% set column = desiredState.config.partitionclause.get('items') | map(attribute='partname.name')| list%}
	 
	      {% for r in column %}
			   {% set nsVariables.partValues = nsVariables.partValues + r %}
         {%- if not loop.last -%} {% set nsVariables.partValues = nsVariables.partValues +','%} {% endif %}
        {% endfor %}
       
         {% set nsVariables.partValues = 'PARTITIONED BY(' + nsVariables.partValues + ')' %}
         

{%endif%}

# Primary key clause

{%if desiredState.config.primary == true%}

   {% set column = desiredState.config.primarykeycon.get('items') | map(attribute='primarykey.name')| list%}
   
	 
	      {% for r in column %}
			   {% set nsVariables.primarykeyValues = nsVariables.primarykeyValues +r %}
         {%- if not loop.last -%} {% set nsVariables.primarykeyValues = nsVariables.primarykeyValues +','%} {% endif %}
        {% endfor %}
       
         {% set nsVariables.primarykeyValues = 'CONSTRAINT ' + desiredState.config.primarykeyname + ' PRIMARY KEY ('+nsVariables.primarykeyValues +')' %}

{%endif%}

#Foreign key clause

{%if desiredState.config.foreign == true%}

   {% set column = desiredState.config.foreignkeycon.get('items') | map(attribute='foreignkey.name')| list%}
	 
	      {% for r in column %}
			   {% set nsVariables.foreignkeyValues = nsVariables.foreignkeyValues +r %}
         {%- if not loop.last -%} {% set nsVariables.foreignkeyValues = nsVariables.foreignkeyValues +','%} {% endif %}
        {% endfor %}
       
         {% set nsVariables.foreignkeyValues = 'CONSTRAINT ' + desiredState.config.foreignkeyname + ' FOREIGN KEY ('+nsVariables.foreignkeyValues +')' + ' REFERENCES '+ desiredState.config.parentabname %}

{%endif%}

#Other constraints

    {%if desiredState.config.constraints == true%}
	
	       {% set column, expression,violation = desiredState.config.constraintsspec.get('items') | map(attribute='columnName.name')| list, desiredState.config.constraintsspec.get('items') | map(attribute='sqlExpression') | list ,
	      desiredState.config.constraintsspec.get('items') | map(attribute='onviolation') | list%}

	     
	    {% for r in column %}
	
			{%set nsVariables.oconstraints = nsVariables.oconstraints + 'CONSTRAINT ' + r + ' EXPECT('+ expression[loop.index0] + ') ON VIOLATION ' + violation[loop.index0] %}
      {% if not loop.last %}
      {%set nsVariables.oconstraints = nsVariables.oconstraints +',' %}

      {% endif %}                
     {% endfor %}
	  {%endif%}



{# CreateSQL for Table #}

{{ stage('CREATE '+ desiredState.config.DLTtype ) }}

CREATE OR REFRESH {{desiredState.config.DLTtype}} 
{%-if desiredState.config.readfiles != true%}{{ ref_no_link(desiredState.node.location.name, desiredState.node.name) }}
{%else%}
`{{tdb}}`.`{{tsch}}`.`{{desiredState.node.name}}`
{%endif%}
{%- if desiredState.config.readfiles != true or desiredState.config.inccolumns == true%}
      (
        {% for col in columns %}
            `{{ col.name }}` {{ col.dataType }}
            {%- if not col.nullable %} NOT NULL
            {% endif %}
            {%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
            {%- if not loop.last %}, {% endif %}
            {%-if loop.last and (desiredState.config.foreign == true or desiredState.config.primary == true) -%},{%endif%}
        {% endfor %}
{% if desiredState.config.primary == true%} {{nsVariables.primarykeyValues}}{%if desiredState.config.foreign == true -%},{%endif-%}{%endif%}
  {%if desiredState.config.foreign == true%}{{nsVariables.foreignkeyValues}}{%endif%}
  {%if desiredState.config.constraints == true%}{{nsVariables.oconstraints}}{%endif%}  )
  {%-endif-%} 
  
    {% if desiredState.node.description | length > 0 -%} COMMENT '{{ desiredState.node.description |escape }}'{%- endif%}
    {% if desiredState.config.partclause == true %} {{ nsVariables.partValues }} {%endif%}
    {%if desiredState.config.tblproperties != ""-%}TBLPROPERTIES ({{desiredState.config.tblproperties}}){%endif%}
    AS
    SELECT 
    {%if desiredState.config.readfiles == true and desiredState.config.inccolumns == false%} * 
    {%else%}
    {% for col in desiredState.sources[0].columns %}
            {%if col.transform == "" %}
                `{{col.name}}`
            {%else%}
                 {{ get_source_transform(col) }} AS `{{ col.name }}`
            {%endif%}
            {%- if not loop.last -%}, {% endif %}
    {% endfor %}
    {%-endif%} 
    FROM {%if desiredState.config.DLTtype == 'STREAMING TABLE'%} STREAM {%endif%}    
    {%if desiredState.config.readfiles == true %} 
       read_files('{{desiredState.config.fileloc}}',format=>'{{desiredState.config.fileformat}}'{%if desiredState.config.fileformat == 'csv'%},delimiter=>'{{desiredState.config.delimiter}}',header=> {%if desiredState.config.header == True %}true {%else%} false{%endif%}{%endif%});
    {%else%}
    (`{{db}}`.`{{sch}}`.`{{desiredState.sources[0].dependencies[0].node.name}}`)
    {{ get_clause_new(join_clause) }}
    {%endif%}
    {%if desiredState.config.refreshstream %}
    {{ stage('REFRESH '+ desiredState.config.DLTtype ) }}
        REFRESH STREAMING TABLE  {{ ref_no_link(desiredState.node.location.name, desiredState.node.name) }}  FULL
    {%endif%}
{%endif%}